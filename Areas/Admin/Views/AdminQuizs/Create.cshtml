@model paradise.ViewModels.QuizCreateVm
@using System.Linq
@{
    ViewBag.Title = "Tạo quiz";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayoutPage1.cshtml";
}
<link href="~/Content/custom-css/CreateView.css" rel="stylesheet" />

<style>
    .question-block {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: .5rem
    }

        .question-block .question-text {
            width: 100%;
            min-height: 100px;
            resize: vertical;
            padding: 10px 12px;
            font-size: 15px
        }

        .question-block .option-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px
        }

            .question-block .option-item .letter {
                background: #e9ecef;
                border-radius: 4px;
                font-weight: 600;
                min-width: 34px;
                text-align: center;
                padding: 8px
            }

        .question-block .option-text {
            flex: 1;
            min-height: 50px;
            resize: vertical;
            padding: 8px 10px;
            font-size: 14px
        }

        .question-block .option-item .form-check-input {
            margin-top: 10px;
            transform: scale(1.15)
        }

        .question-block .delete-option {
            padding: 6px 10px;
            font-size: 13px;
            white-space: nowrap
        }

    .question-type-note {
        font-size: .9rem;
        color: #6c757d
    }
</style>

<div class="page-container">
    <h4 class="fw-bold m-0">Tạo quiz</h4>

    <div class="page-content">
        @using (Html.BeginForm("Create", "AdminQuizs", FormMethod.Post, new { area = "Admin", id = "quizForm", novalidate = "novalidate", autocomplete = "off" }))
        {
            @Html.AntiForgeryToken()
            @Html.ValidationSummary(true, "", new { @class = "text-danger mb-3" })

            <div class="form-card">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Tiêu đề</label>
                        @Html.TextBoxFor(m => m.title, new { @class = "form-control", placeholder = "Nhập tiêu đề", required = "required" })
                        @Html.ValidationMessageFor(m => m.title, "", new { @class = "text-danger" })
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Chủ đề</label>
                        @Html.DropDownListFor(
                            m => m.topic,
                            ViewBag.topicItems as IEnumerable<SelectListItem>,
                            "-- chọn chủ đề --",
                            new { @class = "form-select", required = "required" })
                        @Html.ValidationMessageFor(m => m.topic, "", new { @class = "text-danger" })
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Thời lượng (phút)</label>
                        @Html.TextBoxFor(m => m.time, "{0:0.#}", new { @class = "form-control", type = "number", step = "1", min = "0", id = "time", placeholder = "VD: 30" })
                        @Html.ValidationMessageFor(m => m.time, "", new { @class = "text-danger" })
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Số câu</label>
                        @Html.TextBoxFor(m => m.quantity, new { @class = "form-control", type = "number", min = "1", id = "quantity", placeholder = "VD: 10" })
                        @Html.ValidationMessageFor(m => m.quantity, "", new { @class = "text-danger" })
                    </div>

                    <div class="col-md-4 d-flex align-items-end">
                        <div class="form-check mt-1">
                            @Html.CheckBoxFor(m => m.is_infinity, new { @class = "form-check-input", id = "is_infinity" })
                            <label class="form-check-label" for="is_infinity">Không giới hạn thời gian</label>
                        </div>
                    </div>
                </div>

                <div id="questionsContainer" class="mt-4"></div>

                <div class="actions mt-4">
                    <a class="btn btn-secondary" href="@Url.Action("Index","AdminQuizs", new { area="Admin"})">Hủy</a>
                    <button type="submit" class="btn btn-primary">Tạo mới</button>
                </div>
            </div>
        }
    </div>
</div>

@section scripts{
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const chk = document.getElementById('is_infinity');
            const time = document.getElementById('time');
            const qty = document.getElementById('quantity');
            const box = document.getElementById('questionsContainer');
            const form = document.getElementById('quizForm');

            function toggleTime() {
                if (!chk || !time) return;
                time.disabled = chk.checked;
                time.required = !chk.checked;
                if (chk.checked) time.value = "";
            }
            if (chk) { chk.addEventListener('change', toggleTime); toggleTime(); }

            function autoResize(el) { el.style.height = 'auto'; el.style.height = (el.scrollHeight) + 'px'; }

            function reindexOptions(qIndex, listEl) {
                const items = listEl.querySelectorAll('.option-item');
                items.forEach((optEl, i) => {
                    const letter = optEl.querySelector('.letter');
                    if (letter) letter.textContent = String.fromCharCode(65 + i);

                    const txt = optEl.querySelector('.option-text');
                    if (txt) {
                        txt.name = `Questions[${qIndex}].Options[${i}].option_text`;
                        txt.placeholder = `Đáp án ${String.fromCharCode(65 + i)}`;
                        txt.required = true;
                        txt.disabled = false; // sẽ bị set true khi là essay
                    }

                    const radio = optEl.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.name = `Questions[${qIndex}].CorrectOption`;
                        radio.value = i.toString();
                        radio.required = true;
                        radio.title = "Đáp án đúng";
                        radio.disabled = false; // sẽ bị set true khi là essay
                    }
                });
            }

            // Ẩn/hiện theo loại + đảm bảo essay không post trắc nghiệm
            function syncTypeUI(qBlock) {
                const typeSel = qBlock.querySelector('.q-type');
                const mcWrap = qBlock.querySelector('.mc-wrap');
                const essayWrap = qBlock.querySelector('.essay-wrap');
                const note = qBlock.querySelector('.type-note');
                const isEssay = (typeSel?.value || 'multiple_choice') === 'essay';

                if (isEssay) {
                    // Ẩn & disable inputs trắc nghiệm để không submit
                    if (mcWrap) {
                        mcWrap.style.display = 'none';
                        mcWrap.querySelectorAll('.option-text').forEach(t => { t.required = false; t.disabled = true; });
                        mcWrap.querySelectorAll('input[type="radio"]').forEach(r => { r.required = false; r.checked = false; r.disabled = true; });
                    }
                    if (essayWrap) {
                        essayWrap.style.display = '';
                        // đảm bảo có hidden Options.index=0 cho essay
                        let idxH = essayWrap.querySelector('input[name$=".Options.index"]');
                        if (!idxH) {
                            const h = document.createElement('input');
                            h.type = 'hidden';
                            h.name = `Questions[${qBlock.dataset.qindex}].Options.index`;
                            h.value = '0';
                            essayWrap.appendChild(h);
                        } else {
                            idxH.name = `Questions[${qBlock.dataset.qindex}].Options.index`;
                            idxH.value = '0';
                        }
                        // đảm bảo tên field đúng
                        const ans = essayWrap.querySelector('textarea');
                        if (ans) ans.name = `Questions[${qBlock.dataset.qindex}].Options[0].option_text`;
                    }
                    if (note) note.hidden = false;
                } else {
                    // Bật trắc nghiệm trở lại
                    if (mcWrap) {
                        mcWrap.style.display = '';
                        mcWrap.querySelectorAll('.option-text').forEach(t => { t.required = true; t.disabled = false; });
                        const first = mcWrap.querySelector('input[type="radio"]');
                        if (first && !mcWrap.querySelector('input[type="radio"]:checked')) first.checked = true;
                        mcWrap.querySelectorAll('input[type="radio"]').forEach(r => { r.required = true; r.disabled = false; });
                    }
                    if (essayWrap) {
                        essayWrap.style.display = 'none';
                    }
                    if (note) note.hidden = true;
                }
            }

            function createQuestionBlock(qIndex) {
                const el = document.createElement('div');
                el.className = 'question-block border rounded p-3 mb-3 shadow-sm';
                el.dataset.qindex = qIndex;

                el.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold m-0">Câu hỏi ${qIndex + 1}</h6>
                </div>

                <div class="row g-2 mb-2">
                    <div class="col-md-4">
                        <label class="form-label">Loại câu hỏi</label>
                        <select class="form-select q-type" name="Questions[${qIndex}].question_type">
                            <option value="multiple_choice" selected>Trắc nghiệm</option>
                            <option value="essay">Tự luận</option>
                        </select>
                    </div>
                    <div class="col d-flex align-items-end">
                        
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Nội dung câu hỏi</label>
                    <textarea class="form-control question-text"
                              name="Questions[${qIndex}].question_text"
                              placeholder="Nhập nội dung câu hỏi" rows="1" required></textarea>
                </div>

                <!-- ESSAY ANSWER (lưu Options[0].option_text) -->
                <div class="mb-3 essay-wrap" style="display:none">
                    <label class="form-label">Đáp án</label>
                    <textarea class="form-control essay-answer" rows="2"
                              name="Questions[${qIndex}].Options[0].option_text"
                              placeholder="Nhập đáp án"></textarea>
                    <input type="hidden" name="Questions[${qIndex}].Options.index" value="0" />
                </div>

                <!-- MULTIPLE CHOICE -->
                <div class="mb-2 mc-wrap">
                    <label class="form-label">Các đáp án</label>
                    <div class="option-list"></div>
                    <div class="d-flex gap-2 mt-2">
                        <button type="button" class="btn btn-outline-dark btn-sm add-option">+ Thêm đáp án</button>
                    </div>
                </div>
            `;

                const qText = el.querySelector('.question-text');
                qText.addEventListener('input', () => autoResize(qText)); autoResize(qText);

                const essayAns = el.querySelector('.essay-answer');
                essayAns.addEventListener('input', () => autoResize(essayAns));

                const optionList = el.querySelector('.option-list');
                const addBtn = el.querySelector('.add-option');

                function addOption() {
                    const optEl = document.createElement('div');
                    optEl.className = 'option-item';
                    optEl.innerHTML = `
                    <span class="letter">A</span>
                    <textarea class="option-text" placeholder="Đáp án A" rows="1" required></textarea>
                    <input class="form-check-input mt-1" type="radio">
                    <button type="button" class="btn btn-outline-danger btn-sm delete-option">Xóa</button>
                `;
                    const area = optEl.querySelector('.option-text');
                    area.addEventListener('input', () => autoResize(area)); autoResize(area);

                    optEl.querySelector('.delete-option').addEventListener('click', () => {
                        const items = optionList.querySelectorAll('.option-item');
                        if (items.length <= 2) { alert('Cần ít nhất 2 đáp án.'); return; }
                        optEl.remove();
                        reindexOptions(qIndex, optionList);
                    });

                    optionList.appendChild(optEl);
                    reindexOptions(qIndex, optionList);
                }

                // mặc định 4 đáp án trắc nghiệm
                for (let j = 0; j < 4; j++) addOption();
                const firstRadio = optionList.querySelector('input[type="radio"]');
                if (firstRadio) firstRadio.checked = true;

                addBtn.addEventListener('click', () => addOption());

                // gắn handler cho select loại
                const typeSel = el.querySelector('.q-type');
                typeSel.addEventListener('change', () => syncTypeUI(el));
                syncTypeUI(el);

                return el;
            }

            function renderQuestions(n) {
                box.innerHTML = "";
                n = parseInt(n) || 0;
                if (n <= 0) return;
                for (let i = 0; i < n; i++) {
                    const qb = createQuestionBlock(i);
                    box.appendChild(qb);
                }
            }

            if (qty) {
                qty.addEventListener('input', () => {
                    const v = parseInt(qty.value) || 0;
                    qty.value = v < 1 ? 1 : v;
                    renderQuestions(qty.value);
                });
                if (!qty.value || parseInt(qty.value) < 1) qty.value = 1;
                renderQuestions(qty.value);
            }

            // Hidden index cho model binder (bao gồm essay -> Options.index = 0)
            function addHiddenIndexInputs() {
                form.querySelectorAll('input[name="Questions.index"], input[name$=".Options.index"]').forEach(x => x.remove());

                const qBlocks = document.querySelectorAll('#questionsContainer .question-block');
                qBlocks.forEach((qb, qi) => {
                    const qiHidden = document.createElement('input');
                    qiHidden.type = 'hidden';
                    qiHidden.name = 'Questions.index';
                    qiHidden.value = qi.toString();
                    form.appendChild(qiHidden);

                    const typeSel = qb.querySelector('.q-type');
                    const isEssay = (typeSel?.value || 'multiple_choice') === 'essay';

                    if (isEssay) {
                        // chắc chắn có Options.index = 0 (essay-wrap đã có, nhưng đảm bảo lần cuối)
                        const h = document.createElement('input');
                        h.type = 'hidden';
                        h.name = `Questions[${qi}].Options.index`;
                        h.value = '0';
                        form.appendChild(h);
                    } else {
                        // multiple choice: add index theo số lượng option
                        const optItems = qb.querySelectorAll('.option-list .option-item');
                        optItems.forEach((_, oj) => {
                            const ojHidden = document.createElement('input');
                            ojHidden.type = 'hidden';
                            ojHidden.name = `Questions[${qi}].Options.index`;
                            ojHidden.value = oj.toString();
                            form.appendChild(ojHidden);
                        });
                    }
                });

                const qCount = qBlocks.length;
                if (qCount > 0 && qty) qty.value = qCount;
            }

            if (form) form.addEventListener('submit', () => addHiddenIndexInputs());
        });
    </script>
}
